import { Injectable } from '@angular/core';
import { PersonalizationStrategy } from './personalization.strategy';
import { LocalStorage } from '../storage/localstorage.strategy';
import { UserPreferenceModel } from './user-preference.model';
import { Observable } from 'rxjs/Rx';

@Injectable()
export class UserPersonalizationStrategy implements PersonalizationStrategy {

    constructor(private _localStorage: LocalStorage) {
    }

    /**
     * Gets the favorites from localstorage.
     */
    getFavorites(userName: string): Observable<string[]> {
        return new Observable((observer) => {
            let userPreference = this.getPreferences(userName);
            if (!userPreference) {
                observer.next(null);
            } else {
                observer.next(userPreference.favorites);
            }
        });
    }

    /**
     * Sets the favorites for the current user.
     */
    setFavorites(userName: string, favorites: string[]): void {
        let userPreferences = this.getPreferences(userName);
        if (userPreferences) {
            userPreferences.favorites = favorites;
        }
        this._localStorage.set(`${userName}-preference`, userPreferences || { favorites: favorites });
    }

    /**
     * Gets the user Preferences
     */
    getPreferences(userName: string): UserPreferenceModel {
        return this._localStorage.get(`${userName}-preference`);
    }
}
