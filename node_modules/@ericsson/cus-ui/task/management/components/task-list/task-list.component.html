<cui-container [@state]="animationDirection">
    <cui-block class="task-list-block">
        <div *ngIf="!showDetails" [@fadeInOut]>
            <!-- List Controller -->
            <cui-list-controller [context]="listControllerContext">
                <cui-list-controller-filter (onFilterChange)="_onFilterTable($event)">
                </cui-list-controller-filter>
                <cui-list-controller-general>
                    <div class="select-group" *ngFor="let categoryFilter of tableCategoryFilters">
                        <label>{{categoryFilter.label}}</label>
                        <cui-dynamic-select class="dynamic-filter" [placeholder]="'Make a Choice'"
                            [(ngModel)]="categoryFilter.items" [dataProvider]="categoryFilter.items"
                            (onChange)="_onCategoryFilter($event, categoryFilter.field)">
                        </cui-dynamic-select>
                    </div>
                </cui-list-controller-general>
                <cui-list-controller-action [actions]="groupByFilter" [label]="'Group By:'"
                    [action]="selectedGroupByFilter" (onActionSelect)="_onTableGroupBy($event)">
                </cui-list-controller-action>
            </cui-list-controller>
            <!-- End -->
            <div *ngFor="let group of tableData">
                <h4 class="group-header" *ngIf="group.name && group.name.label; else groupByTitle">
                    {{group.name.label}}</h4>
                <ng-template #groupByTitle>
                    <h4 class="group-header">{{group.name}}</h4>
                </ng-template>
                <!-- Nested Table -->
                <oden-table [rows]="group.data" [cuiElementOverlay]="overlayConfig"
                    (onElementOverlayAction)="_onRetryLoading($event)">
                    <!-- Table Header -->
                    <th odenHeader cellWidth="150" *ngFor="let header of group.header">
                        <oden-table-header-label [label]="header?.label"></oden-table-header-label>
                    </th>
                    <th odenColumnSetSelectorMenu (onColumnVisibilityChanged)="_columnVisibilityChanged($event)">
                    </th>
                    <!-- End -->
                    <ng-template odenRowTemplate let-index="index" let-parent="row">
                        <!-- Table Parent Row -->
                        <tr odenRow [rowId]="index" [hidden]="!parent.searchMatch"
                            [expandedChildRows]="parent.isExpanded" (onExpandChanged)="parent.isExpanded = $event"
                            [data]="parent" (onClick)="_onRowClick($event)" #parentRow>
                            <td odenCell [innerHTML]="parent.taskDisplayName | cuiHighlight : tableFilterText">
                            </td>
                            <td odenCell [innerHTML]="parent.workflowName | cuiHighlight : tableFilterText">
                            </td>
                            <td odenCell [innerHTML]="parent.assignee | cuiHighlight : tableFilterText">
                            </td>
                            <td odenCell [innerHTML]="parent.owner | cuiHighlight : tableFilterText">
                            </td>
                            <td odenCell [innerHTML]="parent.dueDate | cuiHighlight : tableFilterText">
                            </td>
                            <td odenCell>
                                <cui-state-badge [state]="parent.state.state" [label]="parent.state.label"
                                    [color]="parent.state.color" [semiTransparent]="parent.state.semiTransparent"
                                    *ngIf="parent.state">
                                </cui-state-badge>
                            </td>
                            <td odenSingleActionsCell [actions]="singleActionItems"
                                (onAction)="_onSingleAction($event, parent)">
                            </td>
                        </tr>
                        <!-- End -->
                        <ng-container *ngFor="let child of parent?.task">
                            <!-- Child Row -->
                            <tr odenRow [parentId]="parentRow.rowId" [hidden]="!child.searchMatch"
                                [expandedChildRows]="child.isExpanded" (onExpandChanged)="child.isExpanded = $event"
                                [data]="child" (onClick)="_onRowClick($event)" #childRow>
                                <td odenCell [innerHTML]="child.taskDisplayName | cuiHighlight : tableFilterText">
                                </td>
                                <td odenCell [innerHTML]="child.workflowName | cuiHighlight : tableFilterText">
                                </td>
                                <td odenCell [innerHTML]="child.assignee | cuiHighlight : tableFilterText">
                                </td>
                                <td odenCell [innerHTML]="child.owner | cuiHighlight : tableFilterText">
                                </td>
                                <td odenCell [innerHTML]="child.dueDate | cuiHighlight : tableFilterText">
                                </td>
                                <td odenCell>
                                    <cui-state-badge [state]="child.state.state" [label]="child.state.label"
                                        [color]="child.state.color" [semiTransparent]="child.state.semiTransparent"
                                        *ngIf="child.state">
                                    </cui-state-badge>
                                </td>
                                <td odenSingleActionsCell [actions]="singleActionItems"
                                    (onAction)="_onSingleAction($event, child)">
                                </td>
                            </tr>
                            <!-- End -->
                            <!-- Call subChildRowTemplate -->
                            <ng-container [ngTemplateOutlet]="subChildRowTemplate" [ngTemplateOutletContext]="{
                                subChild: subChilds,
                                parentId: childRow.rowId
                                }" *ngFor="let subChilds of child?.task">
                            </ng-container>
                            <!-- End -->
                            <!-- subChildRowTemplate -->
                            <ng-template #subChildRowTemplate let-subChild="subChild" let-parentId="parentId">
                                <tr odenRow [parentId]="parentId" [hidden]="!subChild.searchMatch"
                                    [expandedChildRows]="subChild.isExpanded"
                                    (onExpandChanged)="subChild.isExpanded = $event" [data]="subChild"
                                    (onClick)="_onRowClick($event)" #subChildRow>
                                    <td odenCell
                                        [innerHTML]="subChild.taskDisplayName | cuiHighlight : tableFilterText">
                                    </td>
                                    <td odenCell [innerHTML]="subChild.workflowName | cuiHighlight : tableFilterText">
                                    </td>
                                    <td odenCell [innerHTML]="subChild.assignee | cuiHighlight : tableFilterText">
                                    </td>
                                    <td odenCell [innerHTML]="subChild.owner | cuiHighlight : tableFilterText">
                                    </td>
                                    <td odenCell [innerHTML]="subChild.dueDate | cuiHighlight : tableFilterText">
                                    </td>
                                    <td odenCell>
                                        <cui-state-badge [state]="subChild.state.state" [label]="subChild.state.label"
                                            [color]="subChild.state.color"
                                            [semiTransparent]="subChild.state.semiTransparent" *ngIf="subChild.state">
                                        </cui-state-badge>
                                    </td>
                                    <td odenSingleActionsCell [actions]="singleActionItems"
                                        (onAction)="_onSingleAction($event, subChild)">
                                    </td>
                                </tr>
                                <ng-container [ngTemplateOutlet]="subChildRowTemplate" [ngTemplateOutletContext]="{
                                    subChild: subChilds,
                                    parentId: subChildRow.rowId
                                    }" *ngFor="let subChilds of subChild?.task">
                                </ng-container>
                            </ng-template>
                            <!-- End -->
                        </ng-container>
                    </ng-template>
                </oden-table>
                <!-- End -->
            </div>
        </div>
        <div *ngIf="showDetails" #detailsTemplate [@fadeInOut]>
            <cus-task-details (onBackClick)="_toggleDetails(false)" (onDiscardClick)="_discardTask($event)"
                (onResumeClick)="_navigateToScreenPath($event)" #taskDetails>
            </cus-task-details>
        </div>
    </cui-block>
</cui-container>