const gulp = require('gulp');
const replace = require('gulp-string-replace');

const conf = require('../config');

gulp.task('systemjs_config', ['system_config_build'], replaceSystemJsConfig);
gulp.task('system_config_build', ['cus_ui_config_build'], replaceBuildSystemConfig);
gulp.task('cus_ui_config_build', replaceBuildCusUiConfig);

/* create new system config for compiling with node_modules reference */
function replaceSystemJsConfig(done) {
    var replacedPathAlias = getPathAlias();
    gulp.src([conf.path.tmp('compiled/@ericsson/cus-ui/boilerplate/system-config.js')])
        .pipe(replace(/System.config\({/, replacedPathAlias))
        .pipe(gulp.dest(conf.path.tmp('compiled/prod-config')))
        .on('end', function() { done(); });
}

/* create new system config for compiling with oden mappings reference */
function replaceBuildSystemConfig(done) {
    gulp.src([conf.path.tmp('compiled/@ericsson/cus-ui/boilerplate/system-config.js')])
        .pipe(replace(/oden_mappings \= \[\]/, 'oden_mappings = ' + JSON.stringify(getOdenPackages())))
        .pipe(gulp.dest(conf.path.tmp('compiled/@ericsson/cus-ui/boilerplate')))
        .on('end', function() { done(); });
}

/* create new system config for compiling with oden mappings reference */
function replaceBuildCusUiConfig(done) {
    gulp.src([conf.path.tmp('compiled/@ericsson/cus-ui/boilerplate/system-config.js')])
        .pipe(replace(/cus_ui_mappings \= \[\]/, 'cus_ui_mappings = ' + JSON.stringify(getCusUIPackages())))
        .pipe(gulp.dest(conf.path.tmp('compiled/@ericsson/cus-ui/boilerplate')))
        .on('end', function() { done(); });
}

/* get path alias for system config for node_modules reference*/
function getPathAlias() {
    return 'System.config({ paths: { \'node_modules/@ericsson/\': \'@ericsson/\', \'node_modules/\': \'./node_modules/\' },';
}

function getOdenPackages() {
    return require('@ericsson/oden/configs/system-mappings.json');
}

function getCusUIPackages() {
    return require('@ericsson/cus-ui/cus-ui-mappings.json');
}