<div class="wrapper" (click)="clickBranch($event)">
    <div class="above-content">
        <div
            *ngIf="branchModel.switchLabels.length > 0 || (!branchModel.isOperator && branchModel.isSelectable)"
            class="switcher-options hover-item block-tree-hover-item"
            [class.visible]="branchModel.state.visibleChilds"
            [class.always-show]="branchModel.isSelected || branchModel.state.focused"
            [class.next-to-action-menu]="branchModel.actions.length > 0"
        >
            <div *ngIf="branchModel.switchLabels.length === 2">
                <div class="switcher-group">
                    <cui-switcher [tabIndex]="tabIndex" (focus)="onFocus($event)" (blur)="onBlur($event)" [labelLeft]="branchModel.switchLabels[0]" [labelRight]="branchModel.switchLabels[1]" [(ngModel)]="switcher" (ngModelChange)="switchChange()"></cui-switcher>
                </div>
            </div>
            <div *ngIf="branchModel.switchLabels.length === 1">
                <div class="switcher-group">
                    <span class="field-header right">{{branchModel.switchLabels[0]}}</span>
                    <cui-switcher [tabIndex]="tabIndex" (focus)="onFocus($event)" (blur)="onBlur($event)" [(ngModel)]="switcher" (ngModelChange)="switchChange()"></cui-switcher>
                </div>
            </div>
            <div *ngIf="!branchModel.isOperator && branchModel.isSelectable && branchModel.selectLabel">
                <div class="switcher-group">
                    <span class="field-header right">{{branchModel.selectLabel}}</span>
                    <cui-switcher [tabIndex]="tabIndex" (focus)="onFocus($event)" (blur)="onBlur($event)" [(ngModel)]="branchModel.isSelected" (change)="selectChange()"></cui-switcher>
                </div>
            </div>
        </div>
        <cui-action-menu
            *ngIf="branchModel.actions.length > 0"
            class="hover-item block-tree-hover-item"
            [class.visible]="branchModel.state.visibleChilds"
            (focus)="onFocus($event)"
            (blur)="onBlur($event)"
            [tabIndex]="tabIndex"
            [class.always-show]="branchModel.isSelected || branchModel.state.focused"
            [actions]="branchModel.actions"
            (onActionClick)="actionClick($event)"
        ></cui-action-menu>
        <div class="header"><cui-icon (click)="toggleBranch($event);" [icon]="'chevron-up'" class="small" [style.background]="branchModel.isOperator ? branchModel.color : null"></cui-icon>
            <h4 [class.with-subtitle]="branchModel.subtitle">
                <span class="subtitle" *ngIf="branchModel.subtitle" [innerHTML]="branchModel.subtitle"></span>
                <cui-icon *ngIf="branchModel.icon" [icon]="branchModel.icon" [cuiTooltip]="branchModel.iconTooltip" class="small"></cui-icon>
                <span class="title" [innerHTML]="branchModel.title" [style.color]="branchModel.isOperator ? branchModel.color : null"></span>
                <span class="items-count" [class.hidden]="!filterIsOn && (isExpanded || !branchModel.showItemsCount)">({{itemsCount}})</span>
            </h4>
        </div>
        <div class="extra-header" *ngIf="branchModel.tags.length > 0">
            <cui-tag
                [tabIndex]="tabIndex"
                *ngFor="let tag of branchModel.tags"
                [tag]="tag"
                [readonly]="true"
            ></cui-tag>
        </div>
    </div>
    <div class="content" *ngIf="branchModel.isExpanded">
        <div
            *ngIf="!filterIsOn && (!children[0] || (children[0] && children[0].isDroppableBefore)) && branchModel.isDroppable; else drop_disabled_branch"
            class="cui-dropelement"
            cui-dropelement
            cui-droppable
            [isDroppable]="true"
            (onHover)="toggleParentEngaged(true)"
            (onLeave)="toggleParentEngaged(false)"
            [limit]="branchModel.maxChildren"
            [numberOfItems]="children.length"
            (onDrop)="onBlockDropAtEmptyPosition($event, branchModel, 0)"
            (onReject)="onReject()"
        ><div class="line"></div></div>
        <ng-template #drop_disabled_branch>
            <div
                cui-dropelement
                [disabled]="true"
                cui-droppable
                [isDroppable]="false"
            ></div>
        </ng-template>
        <ng-container *ngFor="let child of children;let i = index">
            <cui-block-tree-branch *ngIf="child | instanceOf:blockTreeBranch"
                [branchModel]="child"
                cui-droppable
                [isDraggable]="isDraggable(child)"
                [isDroppable]="isDroppable(child)"
                (onDrop)="onBranchDrop(child, $event)"
                (onReject)="onReject()"
                (onActionClick)="actionClick($event)"
                cui-draggable2
                [centerElement]="true"
                [cloneWidth]="290"
                [tabIndex]="branchModel.isExpanded ? tabIndex : -1"
                (onHover)="toggleExpandTimeout($event, child)"
                (onLeave)="onLeave()"
                [parent]="branchModel"
                [limit]="child.maxChildren"
                [numberOfItems]="child.children.length"
                [item]="child"
                [attr.data-index]="i+1">
            </cui-block-tree-branch>

            <ng-container *ngIf="child | instanceOf:blockTreeBranchLeaf">
                <cui-block-tree-branch-leaf
                    [leafModel]="child"
                    cui-droppable
                    [isDroppable]="!filterIsOn && child.isDroppable"
                    (onDrop)="onBlockDrop(child, $event)"
                    (onReject)="onReject()"
                    cui-draggable2
                    [centerElement]="true"
                    [cloneWidth]="290"
                    [tabIndex]="branchModel.isExpanded ? tabIndex : -1"
                    [isDraggable]="isDraggable(child)"
                    [item]="child"
                    [parent]="branchModel"
                    [attr.data-index]="i+1">
                </cui-block-tree-branch-leaf>
            </ng-container>

            <div
                *ngIf="showDropElement(branchModel, i); else drop_disabled_leaf"
                cui-dropelement
                cui-droppable [isDroppable]="true"
                [limit]="branchModel.maxChildren"
                (onHover)="toggleParentEngaged(true)"
                (onLeave)="toggleParentEngaged(false)"
                [numberOfItems]="children.length"
                (onDrop)="onBlockDropAtEmptyPosition($event, branchModel, i + 1)"
                (onReject)="onReject()"
            >
                <div class="position-index" [attr.data-index]="i+2"></div>
                <div class="line"></div></div>
            <ng-template #drop_disabled_leaf>
                <div
                    cui-dropelement
                    [disabled]="true"
                    cui-droppable
                    [isDroppable]="false"
                ></div>
            </ng-template>
        </ng-container>
    </div>
</div>
