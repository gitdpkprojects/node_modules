<span class="collapse-block-tree" (click)="toggleAllBranches()" *ngIf="children.length > 0">{{expandOrCollapse}}</span>
<div [@state]="state" [@.disabled]="filterTriggered" class="wrapper-wrapper">
    <div class="wrapper" (click)="clickTree($event)">
        <div class="above-content">
            <div
                *ngIf="blockTree.switchLabels.length > 0 || blockTree.isSelectable"
                class="switcher-options hover-item block-tree-hover-item"
                [class.always-show]="blockTree.isSelected || focused"
                [class.visible]="blockTree.state.visibleChilds"
                [class.next-to-action-menu]="blockTree.actions.length > 0">
                <div *ngIf="blockTree.switchLabels.length === 2">
                    <div class="switcher-group">
                        <cui-switcher [tabIndex]="!blockTree.hideRootNode ? tabIndex : -1" (focus)="onFocus($event)" (blur)="onBlur($event)" [labelLeft]="blockTree.switchLabels[0]" [labelRight]="blockTree.switchLabels[1]" [(ngModel)]="switcher" (ngModelChange)="switchChange()"></cui-switcher>
                    </div>
                </div>
                <div *ngIf="blockTree.switchLabels.length === 1">
                    <div class="switcher-group">
                        <span class="field-header right">{{blockTree.switchLabels[0]}}</span>
                        <cui-switcher [tabIndex]="!blockTree.hideRootNode ? tabIndex : -1" (focus)="onFocus($event)" (blur)="onBlur($event)" [(ngModel)]="switcher" (ngModelChange)="switchChange()"></cui-switcher>
                    </div>
                </div>
                <div *ngIf="blockTree.isSelectable && blockTree.selectLabel">
                    <div class="switcher-group">
                        <span class="field-header right">{{blockTree.selectLabel}}</span>
                        <cui-switcher [tabIndex]="!blockTree.hideRootNode ? tabIndex : -1" (focus)="onFocus($event)" (blur)="onBlur($event)" [(ngModel)]="blockTree.isSelected" (change)="selectChange()"></cui-switcher>
                    </div>
                </div>
            </div>
            <cui-action-menu
                *ngIf="actions.length > 0"
                (blur)="onBlur($event)"
                (focus)="onFocus($event)"
                (onActionClick)="actionClick($event)"
                [actions]="actions"
                [class.always-show]="blockTree.isSelected || focused"
                [class.visible]="blockTree.state.visibleChilds"
                [tabIndex]="!blockTree.hideRootNode ? tabIndex : -1"
                class="hover-item block-tree-hover-item"
            ></cui-action-menu>
            <div class="header"><cui-icon (click)="toggleBranch($event);" [icon]="'chevron-up'" class="small"></cui-icon>
                <h4 [cuiTooltip]="true" [cuiTooltipOnOverflow]="true" [dynamicCuiTooltipContent]="true">{{blockTree.title}}<span class="items-count" [class.hidden]="!filterIsOn && (isExpanded || !blockTree.showItemsCount)">({{itemsCount}})</span></h4>
            </div>
            <div [class.visible]="!blockTree.children.length" class="drop-placeholder"
                 cui-droppable
                 [isDroppable]="blockTree.isDroppable"
                 (onDrop)="onBlockDropAtRootPosition($event, 0)"
                 (onReject)="onReject($event)">
                <div>
                    <h3 *ngIf="placeholderTitle"><cui-icon [icon]="'drop'"></cui-icon>{{placeholderTitle}}</h3>
                    <p *ngIf="placeholderDescription" [cuiTooltip]="placeholderDescription" [cuiTooltipOnOverflow]="true">{{placeholderDescription}}</p>
                    <button cui-button *ngFor="let action of placeholderActions" [attr.tabindex]="children.length ? -1: 0" [class]="action.cssClass ? action.cssClass : null" (click)="placeholderActionClicked(action)" [value]="action.label"></button>
                </div>
            </div>
        </div>
        <div class="content" [class.display-position]="enablePositionDisplay">
            <div
                *ngIf="blockTree.isDroppable && (children[0] && children[0].isDroppableBefore) || !children[0]; else drop_disabled_block_tree"
                cui-dropelement
                cui-droppable [isDroppable]="blockTree.isDroppable"
                [limit]="blockTree.maxChildren"
                [numberOfItems]="children.length"
                (onHover)="toggleParentEngaged(true)"
                (onLeave)="toggleParentEngaged(false)"
                (onDrop)="onBlockDropAtRootPosition($event, 0)"
                (onReject)="onReject($event)"
            ><div *ngIf="blockTree.children.length" class="line"></div></div>
            <ng-template #drop_disabled_block_tree>
                <div
                    cui-dropelement
                    [disabled]="true"
                    cui-droppable
                    [isDroppable]="false"
                ></div>
            </ng-template>

            <ng-container *ngFor="let child of children; let i = index">
                <ng-container *ngIf="child | instanceOf:blockTreeBranch">
                <cui-block-tree-branch
                    [branchModel]="child"
                    cui-droppable
                    [isDraggable]="isDraggable(child)"
                    [isDroppable]="isDroppable(child)"
                    (onDrop)="onBranchDrop(child, $event)"
                    (onReject)="onReject($event)"
                    (onActionClick)="actionClick($event)"
                    (onHover)="toggleExpandTimeout($event, child)"
                    (onLeave)="onLeave()"
                    [tabIndex]="blockTree.isExpanded ? tabIndex : -1"
                    cui-draggable2
                    [centerElement]="true"
                    [cloneWidth]="290"
                    [parent]="blockTree"
                    [limit]="child.maxChildren"
                    [numberOfItems]="child.children.length"
                    [item]="child"
                >
                </cui-block-tree-branch>
                </ng-container>

                <ng-container *ngIf="child | instanceOf:blockTreeBranchLeaf">
                    <cui-block-tree-branch-leaf
                        [leafModel]="child"
                        cui-droppable
                        [isDraggable]="isDraggable(child)"
                        [isDroppable]="!filterIsOn && child.isDroppable"
                        (onDrop)="onBlockDrop(child, $event)"
                        (onReject)="onReject($event)"
                        cui-draggable2
                        [centerElement]="true"
                        [cloneWidth]="290"
                        [tabIndex]="blockTree.isExpanded ? tabIndex : -1"
                        [item]="child"
                        [parent]="blockTree"
                        ></cui-block-tree-branch-leaf>
                </ng-container>
                <div
                    *ngIf="blockTree.isDroppable && isDropElementDroppable(i); else drop_disabled_branch"
                    cui-dropelement
                    cui-droppable [isDroppable]="blockTree.isDroppable"
                    [limit]="blockTree.maxChildren"
                    (onHover)="toggleParentEngaged(true);"
                    (onLeave)="toggleParentEngaged(false);"
                    [numberOfItems]="blockTree.children.length"
                    (onDrop)="onBlockDropAtRootPosition($event, i + 1)"
                    (onReject)="onReject($event)">
                    <div class="line"></div>
                </div>
                <ng-template #drop_disabled_branch>
                    <div
                        cui-dropelement
                        [disabled]="true"
                        cui-droppable
                        [isDroppable]="false"
                    ></div>
                </ng-template>
            </ng-container>
        </div>
    </div>
</div>
